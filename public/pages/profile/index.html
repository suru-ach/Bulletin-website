<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../output.css">
    <title>profile</title>
</head>

<body class=" overflow-x-hidden bg-slate-100">
    <div class="w-screen bg-white shadow-lg flex p-3 md:justify-between">

        <img id="menu-open" class="w-8 cursor-pointer md:hidden" src="../../icons/menu-icon.png" alt="menu">
        <a class="mx-auto flex w-8 space-x-2 justify-center items-center cursor-pointer md:mx-8" href="../../index.html">
            <img src="../../icons/home-icon.png" alt="home">
            <p>bulletin</p>
        </a>

        <ul class="hidden md:flex self-center text-lg">
            <li><a href="../../pages/post/index.html" class="py-[1rem] px-3 hover:bg-sky-300 transition-colors duration-300 hidden post-link">post</a></li>
            <li><a href="../../pages/profile/index.html#logout" class="py-[1rem] px-3 hover:bg-sky-300 transition-colors duration-300">profile</a></li>
            <li><a href="../../pages/calendar/index.html" class="py-[1rem] px-3 hover:bg-sky-300 transition-colors duration-300">calendar</a></li>
            <li><a href="../../pages/login/index.html" class="py-[1rem] px-3 hover:bg-sky-300 transition-colors duration-300">login/register</a></li>
        </ul>

        <div class="w-8 cursor-pointer" id="profile-box">
            <img id="profile-menu" class="aspect-square object-cover rounded-full" src="../../uploads/profile/default.png" alt="">
            <div id="profile-view" class="bg-white w-48 h-[284px] border-2 rounded-md z-50 absolute top-[62px] right-1 p-2 hidden flex-col items-center justify-evenly"></div>
        </div>


        <div id="menu" class="absolute bg-black w-full h-screen flex flex-col inset-0 -left-full transition-all duration-700">
            <img id="menu-close" class="w-8 rounded-[5px] m-3 bg-white cursor-pointer" src="../../icons/close-icon.png" alt="close">
            <a href="../../pages/post/index.html" class="px-3 py-4 hover:bg-sky-300 text-white transition-colors duration-300 hidden post-link">post</a>
            <a href="../../pages/profile/index.html#logout" class="px-3 py-4 hover:bg-sky-300 text-white transition-colors duration-300">profile</a>
            <a href="../../pages/calendar/index.html" class="px-3 py-4 hover:bg-sky-300 text-white transition-colors duration-300">calendar</a>
            <a href="../../pages/login/index.html" class="px-3 py-4 hover:bg-sky-300 text-white transition-colors duration-300">login/register</a>
        </div>
    </div>
    
    <div id="contents" class="w-full h-auto flex flex-col items-center py-3">
        <div class="w-1/2 mt-12">
            <p class="text-left text-4xl">Account Info</p>
        </div>
        <div class="shadow-xl w-[95%] sm:w-[70%] md:w-[60%] lg:w-1/2 bg-white mt-12">
                <div class="flex flex-col sm:flex-row justify-start p-12">
                    <div>
                        <img id="infoImg" class="h-32 w-32 object-cover rounded-full" src="" alt="profile picture">
                    </div>
                    <div class="flex flex-col flex-start mt-12 mx-0 sm:mt-0 sm:mx-12 justify-center">
                        <p id="infoUsername" class="text-3xl">username</p>
                        <p id="infoRole" class="text-slate-600">role: admin</p>
                    </div>
                </div>
            <div class="px-6 pb-6">
                <p class="font-bold">email</p>
                <p id="infoEmail" >email</p>
            </div>
            <div class="px-6 pb-6">
                <p class="font-bold">clubs</p>
                <p id="infoClubs" >clubs...</p>
            </div>
            <div id="logout" class="px-6 pb-6 w-full flex justify-center">
                <button class="bg-sky-600 text-white px-5 py-3 rounded-lg" onclick=logout()>logout</button>
            </div>
        </div>
        <div class="w-1/2 mt-12">
            <p class="text-left text-sky-500 text-4xl">Update account</p>
        </div>
        <div class="shadow-xl w-[95%] sm:w-[70%] md:w-[60%] lg:w-1/2 bg-white mt-12">
            <p id="message-box" class="text-sm mt-3 mx-3 invisible text-black"></p>
            <form id="form" class="flex flex-col w-full p-5 space-y-3">
                <label for="email">Email</label>
                <input id="email" name="email" class="p-3 border-2 border-slate-200 rounded-md focus:outline-none focus:border-sky-500" type="email" placeholder="enter your email" required>
                <label for="newusername">New username</label>
                <input id="newusername" name="newusername" class="p-3 border-2 border-slate-200 rounded-md focus:outline-none focus:border-sky-500" type="text" placeholder="enter your new username" required>
                <label for="password">Password</label>
                <input id="password" name="password" class="p-3 border-2 border-slate-200 rounded-md focus:outline-none focus:border-sky-500" type="password" placeholder="password" required>
                <label for="newpassword">New password</label>
                <input id="newpassword" name="newpassword" class="p-3 border-2 border-slate-200 rounded-md focus:outline-none focus:border-sky-500" type="password" placeholder="new password" required>
                <label for="imagePost">Profile image</label>
                <input id="imagePost" name="imagePost" type="file" accept="image/*">
                <p>Clubs</p>
                <fieldset id="clubs">
                  <label for="aura">aura</label>
                  <input type="checkbox" id="aura">
                  <label for="flc">flc</label>
                  <input type="checkbox" id="flc">
                  <label for="music">music</label>
                  <input type="checkbox" id="music">
                </fieldset>
                <button id="submit" class="p-3 bg-sky-500 text-white rounded-md hover:bg-sky-400" type="submit">update</button>
            </form>
        </div>
        <div class="w-1/2 mt-12">
            <p class="text-left text-red-500 text-4xl">Delete account</p>
        </div>
        <div class="shadow-xl w-[95%] sm:w-[70%] md:w-[60%] lg:w-1/2 bg-white my-12">
            <p id="message-delete" class="text-sm mt-3 mx-3 invisible text-black"></p>
            <form id="deleteForm" class="flex flex-col w-full space-y-3 p-5">
                <label for="deleteEmail">email</label>
                <input id="deleteEmail" name="deleteEmail" class="p-3 border-2 border-slate-200 rounded-md focus:outline-none focus:border-red-500" type="email" placeholder="enter your email" required>
                <label for="deletePassword">password</label>
                <input id="deletePassword" name="deletePassword" class="p-3 border-2 border-slate-200 rounded-md focus:outline-none focus:border-red-500" type="password" placeholder="password" required>
                <button id="delete" class="p-3 bg-red-500 text-white rounded-md hover:bg-red-400" type="submit">Delete</button>
            </form>
        </div>
    </div>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const menu = document.getElementById('menu');
        const menuClose = document.getElementById('menu-close');
        const menuOpen = document.getElementById('menu-open');
        const profileMenu = document.getElementById('profile-menu');
        const profileToggle = document.getElementById('profile-view');
        const postLinks = Array.from(document.querySelectorAll('.post-link'));
        const contents = document.getElementById('contents');   

        const password = document.getElementById('password');
        const email = document.getElementById('email');
        const newpassword = document.getElementById('newpassword');
        const newusername = document.getElementById('newusername');
        const clubs = Array.from(document.querySelectorAll('input[type="checkbox"]'));
        const submit = document.getElementById('submit');
        const imagePost = document.getElementById('imagePost');
        const form = document.getElementById('form');
        const message = document.getElementById('message-box');

        const messageDelete = document.getElementById('message-delete');
        const deleteForm = document.getElementById('deleteForm');
        const deleteEmail = document.getElementById('deleteEmail');
        const deletePassword = document.getElementById('deletePassword');
        const deleteButton = document.getElementById('delete');
        
        const infoImg = document.getElementById('infoImg');
        const infoUsername = document.getElementById('infoUsername');
        const infoRole = document.getElementById('infoRole');
        const infoEmail = document.getElementById('infoEmail');
        const infoClubs = document.getElementById('infoClubs');

        const getUser = async () => {
            const id = localStorage.getItem('id');
            if(id !== null) {
                try {
                    const res = await axios.get(`/auth/user/${id}?type=all`, {
                        headers: {
                            'authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    const {
                        clubs,
                        email,
                        profileImage,
                        role,
                        username,
                        _id
                    } = res.data.payload;
                    infoImg.src = profileImage ? '../..'+profileImage.split('/public')[1] : 'uploads/profile/default.png';
                    infoUsername.innerHTML = username;
                    infoRole.innerHTML = role;
                    infoEmail.innerHTML = email;
                    infoClubs.innerHTML = clubs.length === 0 ? 'none' : clubs;
                } catch(err) {
                    
                }
            }      
        };

        const setUser = () => {
            const role = localStorage.getItem('role');
            const profile = localStorage.getItem('profile') ? '../..'+localStorage.getItem('profile').split('/public')[1] : '../../uploads/profile/default.png';
            const username = localStorage.getItem('username');
            if(role == undefined) {
                contents.innerHTML = '<div>your not logged in</div>';
            }
            if (role == 'admin') {
                postLinks.forEach(link => link.classList.remove('hidden'))
            }

            if (profile) {
                profileMenu.src = profile;
            }
            const html = `
               <div class="p-7">
                 <img class="aspect-square object-cover rounded-full" id="profile" src="${profile ? profile : '../../uploads/profile/default.png'}" alt="profile">
               </div>
               <p class="mb-2">${username ? username : 'guest'}</p>
               ${role ? `<p class="mb-2">role: ${role}</p>` : ''}
               <div class="mb-2 ${role != undefined ? '': 'hidden'}">
                 <a href="../../pages/profile/index.html#logout" class="bg-blue-500 px-3 py-1 rounded-md text-white">edit</a>
                 <a href="../../pages/profile/index.html#logout" class="bg-black px-3 py-1 rounded-md text-white">logout</a>
               </div>
            `;
            profileToggle.innerHTML = html;
        };
        
        const setToken = (data) => {
            for(key in data) {
                localStorage.setItem(key, data[key]);
            }
        };
        
        const updateUser = async(e) => {
            e.preventDefault();
            message.style.visibility = 'visible';
            message.innerHTML = 'loading';
            submit.classList.add('cursor-not-allowed');
            submit.disabled = true;
            const inputClubs = clubs.filter(club => club.checked).map(club => club.id);

            const formData = new FormData();
            formData.append('password', password.value);
            formData.append('email', email.value);
            formData.append('newPassword', newpassword.value);
            formData.append('newUsername', newusername.value);
            formData.append('clubs', inputClubs);
            formData.append('imagePost', imagePost.files[0]);

            try {
                const res = await axios.patch('/auth/register', formData, {
                    headers: {
                        'Content-type': 'multipart/form-data',
                        'authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                message.style.color = 'rgb(34 197 94)';
                message.innerHTML = res.data.message;
                setToken(res.data.payload);
                form.reset();
            } catch(err) {
                message.style.color = 'rgb(220 38 38)';
                message.innerHTML = err.response.data.message;
            }

            submit.disabled = false;
            submit.classList.remove('cursor-not-allowed');
            setTimeout(() => {
                message.style.visibility = 'hidden';
            }, 3000);
        };
        
        
        const deleteUser = async(e) => {
            if(window.confirm('are you sure you want to delete you account!')) {
                e.preventDefault();
                messageDelete.style.visibility = 'visible';
                messageDelete.innerHTML = 'loading';
                deleteButton.classList.add('cursor-not-allowed');
                deleteButton.disabled = true;
                
                const data = {
                    email: deleteEmail.value,
                    password: deletePassword.value
                }

                try {
                    const res = await axios.delete('/auth/register',{
                        headers: {
                            'authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        data
                    });
                    messageDelete.style.color = 'rgb(34 197 94)';
                    messageDelete.innerHTML = res.data.message;
                } catch(err) {
                    messageDelete.style.color = 'rgb(220 38 38)';
                    messageDelete.innerHTML = err.response.data.message;
                }

                deleteButton.disabled = false;
                deleteButton.classList.remove('cursor-not-allowed');
                setTimeout(() => {
                    messageDelete.style.visibility = 'hidden';
                    logout();
                }, 3000);
                deleteForm.reset();
            }
        };
        
        const logout = () => {
            localStorage.clear();
            setUser();
            window.location.href = "../../index.html";
        };

        menuOpen.addEventListener('click', () => {
            menu.classList.remove('-left-full');
        });
        menuClose.addEventListener('click', () => {
            menu.classList.add('-left-full');
        });
        form.addEventListener('submit', e => updateUser(e));
        deleteForm.addEventListener('submit', e => deleteUser(e));
        profileMenu.addEventListener('click', () => {
            if (profileToggle.classList.contains('hidden')) {
                profileToggle.classList.replace('hidden', 'flex');
            } else {
                profileToggle.classList.replace('flex', 'hidden');
            }
        });
        setUser();
        getUser();
    </script>
</body>

</html>